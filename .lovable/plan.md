

# Обновлённый план: База данных → Дашборд + Stage 3

## Обзор изменений

Текущая ситуация:
- **Admin** (`/admin`): уже читает/пишет из Supabase ✅
- **Дашборд** (`/`): читает из CSV файла ❌ → нужно переключить на базу

Цели:
1. Дашборд читает инициативы из базы данных (изменения в админке сразу видны)
2. Cost разблокирован для всех пользователей
3. Stage 3: Система управления людьми и персональными коэффициентами

---

## Этап 1: Дашборд из базы данных

### Задача
Переключить Index.tsx с чтения CSV на чтение из Supabase, чтобы изменения в админке сразу отражались на дашборде.

### Изменения

**Файл: `src/lib/dataManager.ts`**
- Добавить функцию `convertFromDB()` для преобразования `AdminDataRow` → `RawDataRow`
- Маппинг полей: quarterly_data → отдельные поля (cost, onTrack, support и т.д.)

**Файл: `src/pages/Index.tsx`**
- Удалить загрузку CSV из `useEffect`
- Добавить `useInitiatives()` hook для получения данных из базы
- Преобразовывать данные через `convertFromDB()`
- Сохранить drag-drop загрузку CSV как fallback (опционально)

### Результат
```text
Пользователь редактирует в /admin
         ↓
Данные сохраняются в Supabase
         ↓
Дашборд показывает актуальные данные
         ↓
Treemap/Gantt перестраиваются автоматически
```

---

## Этап 2: Stage 3 — Люди и персональные коэффициенты

### Новые таблицы в базе данных

**`people`** — справочник сотрудников:
| Поле | Тип | Описание |
|------|-----|----------|
| id | uuid | Уникальный ID |
| external_id | text | ID из HR-системы |
| full_name | text | ФИО |
| email | text | Рабочая почта |
| hr_structure | text | Полная структура из HR |
| unit | text | Извлечённый Unit |
| team | text | Извлечённая Team |
| position | text | Должность |
| leader | text | Имя лидера |
| hired_at | date | Дата приема |
| terminated_at | date | Дата увольнения |

**`person_initiative_assignments`** — привязка людей к инициативам:
| Поле | Тип | Описание |
|------|-----|----------|
| id | uuid | ID |
| person_id | uuid | FK → people |
| initiative_id | uuid | FK → initiatives |
| quarterly_effort | jsonb | `{"2025-Q1": 30, "2025-Q2": 25}` |

### Логика парсинга HR-структуры

```text
Входная строка: "Dodo Engineering.B2B Pizza.Kitchen Experience.Dev"
                         ↓
Разбить по "."  →  ["Dodo Engineering", "B2B Pizza", "Kitchen Experience", "Dev"]
                         ↓
Unit = 2-й сегмент         →  "B2B Pizza"
Team = последний не-Dev    →  "Kitchen Experience"
```

Пропускаемые суффиксы: `Dev`, `Frontend`, `Backend`

---

## Этап 3: Интерфейс управления людьми

### Новая страница `/admin/people`

**Компоненты:**
```text
+----------------------------------------------------------+
| People Admin                              [Импорт CSV]    |
+----------------------------------------------------------+
| Фильтры: [Unit ▼] [Team ▼] [Квартал ▼] [✓ Активные]     |
+----------------------------------------------------------+
|                                                          |
| +----- Таблица сотрудников -------------------------+    |
| | ФИО          | Команда    | Q1  | Q2  | Q3  | ∑   |    |
| |--------------|------------|-----|-----|-----|-----|    |
| | Иванов И.И.  | Menu       | 85% | 90% | 70% | ✓   |    |
| | Петров П.П.  | Auth&Sec   |120% | 95% | 80% | ⚠   |    |
| +---------------------------------------------------+    |
|                                                          |
+----------------------------------------------------------+
```

### Детали человека (модальное окно)

При клике на строку:
- ФИО, команда, даты найма/увольнения
- Таблица: Инициатива → % усилий по кварталам
- Сумма по каждому кварталу с валидацией (≤100% ✓, >100% ⚠)
- Кнопка "Добавить инициативу"

### Импорт People CSV

Ожидаемые колонки:
| CSV колонка | Поле в базе |
|-------------|-------------|
| id | external_id |
| ФИО | full_name |
| Команда | hr_structure → автопарсинг |
| Должность | position |
| Лидер | leader |
| Дата приема | hired_at |
| Дата увольнения | terminated_at |
| Рабочая почта | email |

---

## Этап 4: Экспорт Coefficients CSV

### Формат вывода для финансов

```csv
ФИО,Email,Команда,Инициатива,Дата найма,Дата увольнения,25_Q1_Effort,25_Q2_Effort,25_Q3_Effort
Иванов И.И.,ivanov@dodo.io,Menu,Заведение продукта,2023-01-15,,15,20,25
Иванов И.И.,ivanov@dodo.io,Menu,Ценообразование,2023-01-15,,10,15,10
Петров П.П.,petrov@dodo.io,Auth,Антифрод,2022-06-01,2025-03-31,50,50,0
```

Формат: Человек → Инициативы → % по кварталам + даты для расчёта частичной занятости

---

## Этап 5: Аудит "кто что заполнил"

### Уже реализовано

Таблица `initiative_history` уже отслеживает все изменения:
- `changed_by` — UUID пользователя
- `changed_at` — время изменения
- `field_name` — какое поле изменено
- `old_value` / `new_value` — старое и новое значение

### Дополнительно

Для people добавим аналогичную историю:
- Таблица `person_assignment_history`
- Триггер на `person_initiative_assignments`

Интерфейс просмотра истории — опционально на следующем этапе.

---

## Новые файлы

| Файл | Описание |
|------|----------|
| `src/pages/AdminPeople.tsx` | Страница управления людьми |
| `src/components/admin/people/PeopleTable.tsx` | Таблица сотрудников |
| `src/components/admin/people/PersonDetailDialog.tsx` | Детали и привязки |
| `src/components/admin/people/CSVPeopleImportDialog.tsx` | Импорт из HR |
| `src/hooks/usePeople.ts` | React Query для people |
| `src/hooks/usePeopleAssignments.ts` | CRUD для привязок |
| `src/lib/peopleDataManager.ts` | Парсинг HR + валидация |

---

## Порядок реализации

1. **Дашборд из базы** — Index.tsx читает из Supabase
2. **Миграции БД** — таблицы people и person_initiative_assignments
3. **Парсер HR** — автоматическое извлечение Unit/Team
4. **Импорт людей** — CSV загрузка с предпросмотром
5. **Привязка к инициативам** — UI редактирования коэффициентов
6. **Валидация** — сумма усилий ≤ 100% per quarter per person
7. **Экспорт** — Coefficients CSV для финансов
8. **Навигация** — ссылки между Admin и AdminPeople

